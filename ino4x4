#include <SPI.h>
#include <Ethernet.h>

// Define the pin numbers for inputs and outputs
const int input1Pin = 2;  // Input 1
const int input2Pin = 3;  // Input 2
const int input3Pin = 4;  // Input 3
const int input4Pin = 5;  // Input 4

const int relay1Pin = 6;   // Relay 1
const int relay2Pin = 7;   // Relay 2
const int relay3Pin = 8;   // Relay 3
const int relay4Pin = 9;   // Relay 4

// Default time thresholds in milliseconds
unsigned long threshold1 = 3000;  // 3 seconds
unsigned long threshold2 = 6000;  // 6 seconds
unsigned long threshold3 = 9000;  // 9 seconds
unsigned long threshold4 = 12000; // 12 seconds

// Variables to track the time the inputs have been HIGH
unsigned long input1Time = 0;
unsigned long input2Time = 0;
unsigned long input3Time = 0;
unsigned long input4Time = 0;

// Ethernet server
EthernetServer server(80);

// MAC and IP address for the Ethernet shield
byte mac[] = { 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED };
IPAddress ip(192, 168, 1, 177);      // Change to your desired IP address
IPAddress netmask(255, 255, 255, 0); // Change to your desired netmask
IPAddress gateway(192, 168, 1, 1);    // Change to your desired gateway

// Login credentials
const char* username = "admin";
const char* password = "Snet2017";
bool loggedIn = false;

void setup() {
    // Initialize the input pins with internal pull-up resistors
    pinMode(input1Pin, INPUT_PULLUP);
    pinMode(input2Pin, INPUT_PULLUP);
    pinMode(input3Pin, INPUT_PULLUP);
    pinMode(input4Pin, INPUT_PULLUP);
    
    // Initialize the relay pins
    pinMode(relay1Pin, OUTPUT);
    pinMode(relay2Pin, OUTPUT);
    pinMode(relay3Pin, OUTPUT);
    pinMode(relay4Pin, OUTPUT);
    
    // Start the Ethernet connection and server
    Ethernet.begin(mac, ip, netmask, gateway);
    server.begin();
    
    Serial.begin(9600);
    Serial.print("Server is at ");
    Serial.println(Ethernet.localIP());
    
    // Test relays on boot
    testRelays();
}

void loop() {
    // Check for client connections
    EthernetClient client = server.available();
    if (client) {
        String currentLine = "";
        while (client.connected()) {
            if (client.available()) {
                char c = client.read();
                if (c == '\n') {
                    // If the current line is blank, you are ready to send a response
                    if (currentLine.length() == 0) {
                        // Check if the user is logged in
                        if (!loggedIn) {
                            // Send login page
                            sendLoginPage(client);
                        } else {
                            // Send main page with threshold configuration
                            sendMainPage(client);
                        }
                        break;
                    } else {
                        // Check for login attempt
                        if (currentLine.startsWith("GET /login")) {
                            String user = getQueryParam(currentLine, "username");
                            String pass = getQueryParam(currentLine, "password");
                            if (strcmp(user.c_str(), username) == 0 && strcmp(pass.c_str(), password) == 0) {
                                loggedIn = true;
                                // Redirect to main page
                                client.println("HTTP/1.1 302 Found");
                                client.println("Location: /");
                                client.println();
                            } else {
                                // Redirect back to login page on failure
                                client.println("HTTP/1.1 302 Found");
                                client.println("Location: /");
                                client.println();
                            }
                        }
                        // Check for threshold setting
                        if (currentLine.startsWith("GET /setThresholds")) {
                            int thresh1 = getQueryParamInt(currentLine, "thresh1");
                            int thresh2 = getQueryParamInt(currentLine, "thresh2");
                            int thresh3 = getQueryParamInt(currentLine, "thresh3");
                            int thresh4 = getQueryParamInt(currentLine, "thresh4");

                            if (thresh1 > 0) threshold1 = thresh1;
                            if (thresh2 > 0) threshold2 = thresh2;
                            if (thresh3 > 0) threshold3 = thresh3;
                            if (thresh4 > 0) threshold4 = thresh4;

                            // Redirect to the main page
                            client.println("HTTP/1.1 302 Found");
                            client.println("Location: /");
                            client.println();
                        }
                    }
                    currentLine = "";
                } else if (c != '\r') {
                    currentLine += c;
                }
            }
        }
        client.stop();
    }

    // Check inputs and trigger relays
    checkInputs();
}

void testRelays() {
    Serial.println("Testing all relays...");
    
    // Turn on each relay with a 2-second delay
    digitalWrite(relay1Pin, HIGH);  
    delay(2000); // Delay for 2 seconds
    digitalWrite(relay1Pin, LOW);   // Turn off relay 1

    digitalWrite(relay2Pin, HIGH);  
    delay(2000); // Delay for 2 seconds
    digitalWrite(relay2Pin, LOW);   // Turn off relay 2

    digitalWrite(relay3Pin, HIGH);  
    delay(2000); // Delay for 2 seconds
    digitalWrite(relay3Pin, LOW);   // Turn off relay 3

    digitalWrite(relay4Pin, HIGH);  
    delay(2000); // Delay for 2 seconds
    digitalWrite(relay4Pin, LOW);   // Turn off relay 4

    Serial.println("All relays tested and released.");
}

void checkInputs() {
    // Check input 1
    if (digitalRead(input1Pin) == LOW) { // LOW means button pressed if using pull-up
        input1Time += millis();
        if (input1Time >= threshold1) {
            digitalWrite(relay1Pin, HIGH); // Trigger relay 1
        }
    } else {
        input1Time = 0; // Reset timer if input goes HIGH
        digitalWrite(relay1Pin, LOW); // Ensure relay 1 is off
    }

    // Check input 2
    if (digitalRead(input2Pin) == LOW) { // LOW means button pressed if using pull-up
        input2Time += millis();
        if (input2Time >= threshold2) {
            digitalWrite(relay2Pin, HIGH); // Trigger relay 2
        }
    } else {
        input2Time = 0; // Reset timer if input goes HIGH
        digitalWrite(relay2Pin, LOW); // Ensure relay 2 is off
    }

    // Check input 3
    if (digitalRead(input3Pin) == LOW) { // LOW means button pressed if using pull-up
        input3Time += millis();
        if (input3Time >= threshold3) {
            digitalWrite(relay3Pin, HIGH); // Trigger relay 3
        }
    } else {
        input3Time = 0; // Reset timer if input goes HIGH
        digitalWrite(relay3Pin, LOW); // Ensure relay 3 is off
    }

    // Check input 4
    if (digitalRead(input4Pin) == LOW) { // LOW means button pressed if using pull-up
        input4Time += millis();
        if (input4Time >= threshold4) {
            digitalWrite(relay4Pin, HIGH); // Trigger relay 4
        }
    } else {
        input4Time = 0; // Reset timer if input goes HIGH
        digitalWrite(relay4Pin, LOW); // Ensure relay 4 is off
    }

    // Delay to prevent rapid cycling
    delay(100); // Adjust as needed
}

void sendLoginPage(EthernetClient &client) {
    client.println("HTTP/1.1 200 OK");
    client.println("Content-type:text/html");
    client.println();
    client.println("<!DOCTYPE HTML>");
    client.println("<html>");
    client.println("<head><title>Login</title></head>");
    client.println("<body>");
    client.println("<h1>Login</h1>");
    client.println("<form action=\"/login\" method=\"GET\">");
    client.println("Username: <input type=\"text\" name=\"username\"><br>");
    client.println("Password: <input type=\"password\" name=\"password\"><br>");
    client.println("<input type=\"submit\" value=\"Login\">");
    client.println("</form>");
    client.println("</body>");
    client.println("</html>");
}

void sendMainPage(EthernetClient &client) {
    client.println("HTTP/1.1 200 OK");
    client.println("Content-type:text/html");
    client.println();
    client.println("<!DOCTYPE HTML>");
    client.println("<html>");
    client.println("<head><title>Threshold Configuration</title></head>");
    client.println("<body>");
    client.println("<h1>Set Time Thresholds</h1>");
    client.println("<form action=\"/setThresholds\" method=\"GET\">");
    client.println("Threshold 1 (ms): <input type=\"text\" name=\"thresh1\"><br>");
    client.println("Threshold 2 (ms): <input type=\"text\" name=\"thresh2\"><br>");
    client.println("Threshold 3 (ms): <input type=\"text\" name=\"thresh3\"><br>");
    client.println("Threshold 4 (ms): <input type=\"text\" name=\"thresh4\"><br>");
    client.println("<input type=\"submit\" value=\"Set Thresholds\">");
    client.println("</form>");
    client.println("</body>");
    client.println("</html>");
}

String getQueryParam(String request, String param) {
    int startIndex = request.indexOf(param + "=");
    if (startIndex == -1) return "";
    startIndex += param.length() + 1; // Move past the parameter name and '='
    int endIndex = request.indexOf("&", startIndex);
    if (endIndex == -1) endIndex = request.indexOf(" ", startIndex);
    return request.substring(startIndex, endIndex);
}

int getQueryParamInt(String request, String param) {
    String value = getQueryParam(request, param);
    return value.toInt();
}
